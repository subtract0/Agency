<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agency Kanban</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #0b0f14; color: #e6eef7; }
    header { padding: 12px 16px; border-bottom: 1px solid #223; position: sticky; top:0; background:#0b0f14; }
    .columns { display: flex; gap: 12px; padding: 12px; }
    .col { flex: 1; background: #101820; border:1px solid #223; border-radius: 8px; padding: 8px; min-height: 70vh; }
    .col h2 { margin: 6px 6px 8px; font-size: 16px; color: #9ecbff; }
    .card { background:#0f141a; border:1px solid #253241; border-radius: 8px; padding: 8px; margin: 8px; }
    .card h3 { margin: 0 0 6px; font-size: 14px; color: #e6eef7; }
    .card p { margin: 0; font-size: 12px; color:#c6d3e3; }
    .meta { font-size: 11px; color:#98a6b3; margin-top: 6px; }
    .tag { display:inline-block; padding: 2px 6px; background:#1a2633; color:#9ecbff; border-radius: 999px; font-size:10px; margin-right: 4px; }
  </style>
</head>
<body>
<header>
  <strong>Agency Kanban</strong>
  <span id="stamp" style="margin-left: 8px; color:#98a6b3; font-size:12px"></span>
</header>
<div class="columns">
  <div class="col" id="to-investigate"><h2>To Investigate</h2></div>
  <div class="col" id="in-progress"><h2>In Progress</h2></div>
  <div class="col" id="learned"><h2>Learned</h2></div>
  <div class="col" id="resolved"><h2>Resolved</h2></div>
</div>
<script>
  async function fetchCards() {
    try {
      const res = await fetch('/kanban/cards.json', {cache:'no-store'});
      const data = await res.json();
      render(data.cards || [], data.generated_at);
    } catch (e) {
      console.log('Failed to load cards', e);
    }
  }
  function el(tag, attrs={}, ...children) {
    const x = document.createElement(tag);
    Object.entries(attrs || {}).forEach(([k,v]) => x.setAttribute(k,v));
    children.forEach(c => x.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
    return x;
  }
  function cardView(c) {
    const tags = (c.tags || []).map(t => el('span', {class:'tag'}, t));
    return el('div', {class:'card'},
      el('h3', {}, c.title || c.type || 'Card'),
      el('p', {}, c.summary || ''),
      el('div', {class:'meta'}, `${c.created_at || ''} â€¢ ${c.source_ref || ''}`),
      el('div', {}, ...tags)
    );
  }
  function render(cards, stamp) {
    document.getElementById('stamp').textContent = stamp ? `updated ${stamp}` : '';
    const colMap = {
      'To Investigate': document.getElementById('to-investigate'),
      'In Progress': document.getElementById('in-progress'),
      'Learned': document.getElementById('learned'),
      'Resolved': document.getElementById('resolved'),
    };
    // Clear columns (preserve headers)
    Object.values(colMap).forEach(col => {
      [...col.querySelectorAll('.card')].forEach(n => n.remove());
    });
    // Append cards by status
    cards.forEach(c => {
      const col = colMap[c.status] || colMap['To Investigate'];
      col.appendChild(cardView(c));
    });
  }
  fetchCards();
  setInterval(fetchCards, 5000);
</script>
</body>
</html>